<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Lucky Casino</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat :wght@400;700&family=Playfair+Display:wght@700&display=swap"
        rel="stylesheet">
  <style>
    <!-- –°—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
    <!-- –í—Å—Ç–∞–≤—å —Å—é–¥–∞ CSS –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ñ–∞–π–ª–∞ -->
  </style>
</head>
<body>
<div id="app">
  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
  <!-- –¢—ã —É–∂–µ –≤—Å—Ç–∞–≤–ª—è–ª –µ–≥–æ —Ä–∞–Ω–µ–µ -->
</div>

<!-- Notification -->
<div class="notification" id="notification"></div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js ';
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged }
         from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js ';
  import { getDatabase, ref, get, set, update, remove, onValue }
         from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js ';

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBxfwUv-1hQq_wYPrQviHqrb49OVRUaRGU",
    authDomain: "cazic-7f172.firebaseapp.com",
    projectId: "cazic-7f172",
    storageBucket: "cazic-7f172.firebasestorage.app",
    messagingSenderId: "440121668783",
    appId: "1:440121668783:web:9d48a2ed805cfa3161905a",
    measurementId: "G-Y0XNWB0F4N"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app);

  let users = {};
  let currentUser = null;
  let selectedDiceNumber = 3;
  let gameHistory = {};

  window.onload = function () {
    showLogin();
    setupDiceNumbers();
    setupSlots();

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Firebase
    onValue(ref(db, 'users'), snapshot => {
      users = snapshot.val() || {};
      updateAdminPanel();
    });

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∏–≥—Ä
    onValue(ref(db, 'gameHistory'), snapshot => {
      gameHistory = snapshot.val() || {};
    });
  };

  function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification show';
    if (isError) notification.classList.add('error');
    setTimeout(() => notification.classList.remove('show'), 3000);
  }

  function showRegister() {
    document.getElementById('login-form').style.display = 'none';
    document.getElementById('register-form').style.display = 'block';
  }

  function showLogin() {
    document.getElementById('register-form').style.display = 'none';
    document.getElementById('login-form').style.display = 'block';
  }

  function register() {
    const username = document.getElementById('register-username').value.trim();
    const password = document.getElementById('register-password').value;
    const balance = parseInt(document.getElementById('register-start-balance').value) || 1000;

    if (!username || !password) {
      showNotification('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å', true);
      return;
    }
    if (username.length < 3) {
      showNotification('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤', true);
      return;
    }
    if (password.length < 4) {
      showNotification('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤', true);
      return;
    }

    get(ref(db, 'users/' + username)).then(snapshot => {
      if (snapshot.exists()) {
        showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', true);
      } else {
        set(ref(db, 'users/' + username), {
          password,
          balance
        });

        set(ref(db, 'gameHistory/' + username), {
          dice: [],
          slots: []
        });

        showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.');
        showLogin();
      }
    }).catch(error => {
      console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", error);
      showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', true);
    });
  }

  function login() {
    const username = document.getElementById('login-username').value.trim();
    const password = document.getElementById('login-password').value;

    get(ref(db, 'users/' + username)).then(snapshot => {
      const user = snapshot.val();
      if (user && user.password === password) {
        currentUser = username;
        document.getElementById('auth-forms').style.display = 'none';
        document.getElementById('casino').style.display = 'block';
        updateUserInfo();
        loadGameHistory();
        showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${username}!`);
      } else {
        showNotification('–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å', true);
      }
    }).catch(error => {
      console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
      showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', true);
    });
  }

  function updateUserInfo() {
    document.getElementById('username-display').textContent = currentUser;
    document.getElementById('balance').textContent = users[currentUser]?.balance || 0;

    const adminBtn = document.getElementById('admin-button');
    if (currentUser === 'EsAzazel') {
      adminBtn.style.display = 'inline-block';
      updateAdminPanel();
    } else {
      adminBtn.style.display = 'none';
    }
  }

  function logout() {
    currentUser = null;
    document.getElementById('casino').style.display = 'none';
    document.getElementById('auth-forms').style.display = 'block';
    showLogin();
  }

  function switchGame(game) {
    document.querySelectorAll('.game').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.game-tab').forEach(el => el.classList.remove('active'));
    document.getElementById(`${game}-game`).classList.add('active');
    const tabs = document.querySelectorAll('.game-tab');
    for (let tab of tabs) {
      if (tab.textContent.toLowerCase().includes(game)) {
        tab.classList.add('active');
        break;
      }
    }
  }

  function setBetAmount(amount, game) {
    document.getElementById(`${game}-bet-amount`).value = amount;
  }

  function setMaxBet(game) {
    document.getElementById(`${game}-bet-amount`).value = users[currentUser].balance;
  }

  function loadGameHistory() {
    if (!currentUser || !gameHistory[currentUser]) return;
    const diceHistory = (gameHistory[currentUser].dice || []).slice(-10).reverse();
    const diceHistoryEl = document.getElementById('dice-history');
    diceHistoryEl.innerHTML = '';
    diceHistory.forEach(item => {
      const historyItem = document.createElement('div');
      historyItem.className = `history-item ${item.win ? 'history-win' : 'history-lose'}`;
      historyItem.innerHTML = `
                <span>${item.type}: ${item.number} (${item.result})</span>
                <span>${item.win ? '+' : '-'}${item.amount}</span>
            `;
      diceHistoryEl.appendChild(historyItem);
    });

    const slotsHistory = (gameHistory[currentUser].slots || []).slice(-10).reverse();
    const slotsHistoryEl = document.getElementById('slots-history');
    slotsHistoryEl.innerHTML = '';
    slotsHistory.forEach(item => {
      const historyItem = document.createElement('div');
      historyItem.className = `history-item ${item.win ? 'history-win' : 'history-lose'}`;
      historyItem.innerHTML = `
                <span>${item.symbols.join(' ')}</span>
                <span>${item.win ? '+' : '-'}${item.amount}</span>
            `;
      slotsHistoryEl.appendChild(historyItem);
    });
  }

  function addToHistory(game, data) {
    if (!currentUser) return;
    if (!gameHistory[currentUser]) gameHistory[currentUser] = { dice: [], slots: [] };
    gameHistory[currentUser][game].push(data);
    if (gameHistory[currentUser][game].length > 50) gameHistory[currentUser][game].shift();
    set(ref(db, 'gameHistory/' + currentUser), gameHistory[currentUser]);
    loadGameHistory();
  }

  function setupDiceNumbers() {
    selectDiceNumber(3);
  }

  function selectDiceNumber(number) {
    selectedDiceNumber = number;
    document.querySelectorAll('.dice-number').forEach(el => {
      el.classList.remove('selected');
      if (parseInt(el.textContent) === number) {
        el.classList.add('selected');
      }
    });
  }

  function playDice() {
    if (!currentUser) return;
    const bet = parseInt(document.getElementById('dice-bet-amount').value);
    const user = users[currentUser];
    if (isNaN(bet) || bet < 1) {
      showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É', true);
      return;
    }
    if (bet > user.balance) {
      showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', true);
      return;
    }
    if (!selectedDiceNumber) {
      showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 6', true);
      return;
    }

    const diceRollEl = document.getElementById('dice-roll');
    diceRollEl.textContent = '?';
    diceRollEl.classList.add('dice-rolling');

    const resultEl = document.getElementById('dice-result');
    resultEl.classList.remove('show');
    resultEl.className = 'game-result';

    setTimeout(() => {
      const diceRoll = Math.floor(Math.random() * 6) + 1;
      diceRollEl.classList.remove('dice-rolling');
      diceRollEl.textContent = diceRoll;

      if (diceRoll === selectedDiceNumber) {
        const winAmount = bet * 5;
        user.balance += winAmount;
        resultEl.textContent = `–í—ã–ø–∞–ª–æ: ${diceRoll}. –í—ã —É–≥–∞–¥–∞–ª–∏ –∏ –≤—ã–∏–≥—Ä–∞–ª–∏ $${winAmount}!`;
        resultEl.classList.add('show', 'result-win');
        addToHistory('dice', {
          type: '–ö–æ—Å—Ç–∏',
          number: selectedDiceNumber,
          result: diceRoll,
          amount: winAmount,
          win: true
        });
      } else {
        user.balance -= bet;
        resultEl.textContent = `–í—ã–ø–∞–ª–æ: ${diceRoll}. –í—ã –Ω–µ —É–≥–∞–¥–∞–ª–∏ –∏ –ø–æ—Ç–µ—Ä—è–ª–∏ $${bet}.`;
        resultEl.classList.add('show', 'result-lose');
        addToHistory('dice', {
          type: '–ö–æ—Å—Ç–∏',
          number: selectedDiceNumber,
          result: diceRoll,
          amount: bet,
          win: false
        });
      }

      update(ref(db, 'users/' + currentUser), { balance: user.balance });
      updateUserInfo();
    }, 1000);
  }

  const slotSymbols = ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '7Ô∏è‚É£', 'üîî', 'üí∞'];

  function setupSlots() {
    const reels = document.querySelectorAll('.slots-reel');
    reels.forEach(reel => {
      reel.innerHTML = '';
      for (let i = 0; i < 5; i++) {
        const randomSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        const symbol = document.createElement('div');
        symbol.className = 'slots-symbol';
        symbol.textContent = randomSymbol;
        symbol.style.transform = `translateY(${i * 120}px)`;
        reel.appendChild(symbol);
      }
    });
  }

  function playSlots() {
    if (!currentUser) return;
    const bet = parseInt(document.getElementById('slots-bet-amount').value);
    const user = users[currentUser];
    if (isNaN(bet) || bet < 1) {
      showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É', true);
      return;
    }
    if (bet > user.balance) {
      showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', true);
      return;
    }

    const reels = document.querySelectorAll('.slots-reel');
    reels.forEach(reel => reel.classList.add('slots-spinning'));

    const resultEl = document.getElementById('slots-result');
    resultEl.classList.remove('show');
    resultEl.className = 'game-result';

    setTimeout(() => stopSlotReel(reels[0], 0), 1000);
    setTimeout(() => stopSlotReel(reels[1], 1), 1500);
    setTimeout(() => stopSlotReel(reels[2], 2), 2000);
    setTimeout(() => checkSlotsResult(bet), 2500);
  }

  function stopSlotReel(reel, index) {
    reel.classList.remove('slots-spinning');
    const randomSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
    const symbols = reel.querySelectorAll('.slots-symbol');
    symbols.forEach((symbol, i) => {
      if (i === 2) {
        symbol.textContent = randomSymbol;
      } else {
        symbol.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
      }
      symbol.style.transform = `translateY(${(i - 2) * 120}px)`;
    });
  }

  function checkSlotsResult(bet) {
    const reels = document.querySelectorAll('.slots-reel');
    const symbols = [];
    reels.forEach(reel => {
      const centerSymbol = reel.querySelectorAll('.slots-symbol')[2];
      symbols.push(centerSymbol.textContent);
    });

    let winAmount = 0;
    let winMessage = '';

    if (symbols[0] === symbols[1] && symbols[1] === symbols[2]) {
      if (symbols[0] === '7Ô∏è‚É£') {
        winAmount = bet * 10;
        winMessage = '–î–ñ–ï–ö–ü–û–¢! –¢—Ä–∏ 7Ô∏è‚É£!';
      } else if (symbols[0] === 'üí∞') {
        winAmount = bet * 5;
        winMessage = '–û—Ç–ª–∏—á–Ω–æ! –¢—Ä–∏ üí∞!';
      } else {
        winAmount = bet * 3;
        winMessage = `–•–æ—Ä–æ—à–æ! –¢—Ä–∏ ${symbols[0]}!`;
      }
    } else if (symbols[0] === symbols[1] || symbols[1] === symbols[2] || symbols[0] === symbols[2]) {
      winAmount = bet;
      winMessage = '–ù–µ –ø–ª–æ—Ö–æ! –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞!';
    }

    const user = users[currentUser];
    const resultEl = document.getElementById('slots-result');

    if (winAmount > 0) {
      user.balance += winAmount;
      resultEl.textContent = `${winMessage} –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ $${winAmount}!`;
      resultEl.classList.add('show', 'result-win');
      addToHistory('slots', {
        symbols: symbols,
        amount: winAmount,
        win: true
      });
    } else {
      user.balance -= bet;
      resultEl.textContent = `${symbols.join(' ')} ‚Äî –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ $${bet}.`;
      resultEl.classList.add('show', 'result-lose');
      addToHistory('slots', {
        symbols: symbols,
        amount: bet,
        win: false
      });
    }

    update(ref(db, 'users/' + currentUser), { balance: user.balance });
    updateUserInfo();
  }

  // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
  function toggleAdminPanel() {
    const panel = document.getElementById('admin-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  }

  function updateAdminPanel() {
    const userListDiv = document.getElementById('users-list');
    userListDiv.innerHTML = '';
    Object.keys(users).forEach(username => {
      const user = users[username];
      const userDiv = document.createElement('div');
      userDiv.className = 'admin-user-row';
      userDiv.innerHTML = `
                <span><strong>${username}</strong>: $${user.balance}</span>
                <input type="number" id="balance-${username}" value="${user.balance}" style="width: 100px;">
                <button class="btn-primary" onclick="updateUserBalance('${username}')">–û–±–Ω–æ–≤–∏—Ç—å</button>
                <button class="btn-danger" onclick="deleteUser('${username}')">–£–¥–∞–ª–∏—Ç—å</button>
            `;
      userListDiv.appendChild(userDiv);
    });
  }

  function updateUserBalance(username) {
    const input = document.getElementById(`balance-${username}`);
    const newBalance = parseInt(input.value);
    if (!isNaN(newBalance)) {
      update(ref(db, 'users/' + username), { balance: newBalance });
      showNotification(`–ë–∞–ª–∞–Ω—Å ${username} –æ–±–Ω–æ–≤–ª—ë–Ω`);
    } else {
      showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ', true);
    }
  }

  function deleteUser(username) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç "${username}"?`)) return;
    remove(ref(db, 'users/' + username));
    remove(ref(db, 'gameHistory/' + username));
    showNotification(`–ê–∫–∫–∞—É–Ω—Ç "${username}" —É–¥–∞–ª–µ–Ω`);
  }

</script>
</body>
</html>
