<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js ';
    import { getAuth } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js ';
    import { getDatabase, ref, get, set, update } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js ';

    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCLlS2eLm0bsJCLaNd1hlO7Mir-hjkaD-w",
        authDomain: "cazic-es.firebaseapp.com",
        projectId: "cazic-es",
        storageBucket: "cazic-es.firebasestorage.app",
        messagingSenderId: "13490596562",
        appId: "1:13490596562:web:40c09f406ecc671bccdb0b",
        measurementId: "G-N19P006ZHM"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const database = getDatabase(app);

    let currentUser = null;
    let selectedDiceNumber = 3;
    let selectedCoinSide = null;

    window.onload = function () {
        showLogin();
        setupDiceNumbers();
        setupSlots();
    };

    function showNotification(message, isError = false) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = 'notification show';
        if (isError) notification.classList.add('error');
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function showRegister() {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
    }

    function showLogin() {
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
    }

    async function register() {
        const username = document.getElementById('register-username').value.trim();
        const password = document.getElementById('register-password').value;
        const balance = parseInt(document.getElementById('register-start-balance').value) || 1000;

        if (!username || !password) {
            showNotification("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –ø–∞—Ä–æ–ª—å", true);
            return;
        }

        const userRef = ref(database, 'users/' + username);
        const snapshot = await get(userRef);

        if (snapshot.exists()) {
            showNotification("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç", true);
            return;
        }

        await set(ref(database, 'users/' + username), {
            password: password,
            balance: balance,
            lastLogin: null
        });

        await set(ref(database, 'history/' + username), {
            dice: [],
            slots: [],
            coin: []
        });

        showNotification("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏.");
        showLogin();
    }

    async function login() {
        const username = document.getElementById('login-username').value.trim();
        const password = document.getElementById('login-password').value;

        const userRef = ref(database, 'users/' + username);
        const snapshot = await get(userRef);

        if (!snapshot.exists() || snapshot.val().password !== password) {
            showNotification("–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø–∞—Ä–æ–ª—å", true);
            return;
        }

        currentUser = username;
        document.getElementById('auth-forms').style.display = 'none';
        document.getElementById('casino').style.display = 'block';
        updateUserInfo();
        loadGameHistory();

        const userData = snapshot.val();
        const now = Date.now();
        const lastLogin = userData.lastLogin || 0;

        if (now - lastLogin > 86400000) { // 24 —á–∞—Å–∞
            const newBalance = userData.balance + 1000;
            await update(ref(database, 'users/' + username), {
                balance: newBalance,
                lastLogin: now
            });
            showNotification(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –æ–±—Ä–∞—Ç–Ω–æ! –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ 1000 –º–æ–Ω–µ—Ç.`);
        }

        if (username === 'EsAzazel') {
            document.getElementById('admin-panel').style.display = 'block';
            loadUserList();
            loadLeaderboard();
        }

        updateUserInfo();
    }

    async function updateUserInfo() {
        document.getElementById('username-display').textContent = currentUser;

        const userSnapshot = await get(ref(database, 'users/' + currentUser));
        const user = userSnapshot.val();

        const balanceEl = document.getElementById('balance');
        balanceEl.textContent = user.balance;
    }

    async function loadGameHistory() {
        if (!currentUser) return;

        const historySnapshot = await get(ref(database, 'history/' + currentUser));
        const history = historySnapshot.val() || { dice: [], slots: [], coin: [] };

        displayHistory(history);
    }

    function displayHistory(history) {
        const diceHistoryEl = document.getElementById('dice-history');
        const slotsHistoryEl = document.getElementById('slots-history');
        const coinHistoryEl = document.getElementById('coin-history');

        diceHistoryEl.innerHTML = '';
        slotsHistoryEl.innerHTML = '';
        coinHistoryEl.innerHTML = '';

        (history.dice.slice(-10).reverse() || []).forEach(item => {
            const el = createHistoryItem(item, item.number, item.result, item.amount, item.win);
            diceHistoryEl.appendChild(el);
        });

        (history.slots.slice(-10).reverse() || []).forEach(item => {
            const symbols = item.symbols.join(' ');
            const el = createHistoryItem(item, symbols, '', item.amount, item.win);
            slotsHistoryEl.appendChild(el);
        });

        (history.coin.slice(-10).reverse() || []).forEach(item => {
            const choice = item.choice === 'heads' ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞';
            const result = item.result === 'heads' ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞';
            const el = createHistoryItem(item, `${choice} (${result})`, '', item.amount, item.win);
            coinHistoryEl.appendChild(el);
        });
    }

    function createHistoryItem(item, leftText, rightText, amount, win) {
        const div = document.createElement('div');
        div.className = `history-item ${win ? 'history-win' : 'history-lose'}`;
        div.innerHTML = `
            <span>${leftText}${rightText ? `: ${rightText}` : ''}</span>
            <span>${win ? '+' : '-'}${amount}</span>
        `;
        return div;
    }

    async function addToHistory(game, data) {
        if (!currentUser) return;
        const historyRef = ref(database, `history/${currentUser}/${game}`);
        const snapshot = await get(historyRef);
        const list = snapshot.val() || [];
        list.push(data);
        if (list.length > 50) list.shift();
        await set(historyRef, list);
        loadGameHistory();
    }

    function setupDiceNumbers() {
        selectDiceNumber(3);
    }

    function selectDiceNumber(number) {
        selectedDiceNumber = number;
        document.querySelectorAll('.dice-number').forEach(el => {
            el.classList.remove('selected');
            if (parseInt(el.textContent) === number) {
                el.classList.add('selected');
            }
        });
    }

    async function playDice() {
        if (!currentUser) return;

        const bet = parseInt(document.getElementById('dice-bet-amount').value);
        const userSnapshot = await get(ref(database, 'users/' + currentUser));
        const user = userSnapshot.val();

        if (isNaN(bet) || bet < 1) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É', true);
            return;
        }
        if (bet > user.balance) {
            showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', true);
            return;
        }

        const diceRoll = Math.floor(Math.random() * 6) + 1;

        if (diceRoll === selectedDiceNumber) {
            const winAmount = bet * 5;
            await update(ref(database, 'users/' + currentUser), {
                balance: user.balance + winAmount
            });
            addToHistory('dice', {
                number: selectedDiceNumber,
                result: diceRoll,
                amount: winAmount,
                win: true
            });
            showNotification(`–í—ã–ø–∞–ª–æ: ${diceRoll}. –í—ã —É–≥–∞–¥–∞–ª–∏ –∏ –≤—ã–∏–≥—Ä–∞–ª–∏ $${winAmount}!`);
        } else {
            await update(ref(database, 'users/' + currentUser), {
                balance: user.balance - bet
            });
            addToHistory('dice', {
                number: selectedDiceNumber,
                result: diceRoll,
                amount: bet,
                win: false
            });
            showNotification(`–í—ã–ø–∞–ª–æ: ${diceRoll}. –í—ã –Ω–µ —É–≥–∞–¥–∞–ª–∏ –∏ –ø–æ—Ç–µ—Ä—è–ª–∏ $${bet}.`);
        }

        updateUserInfo();
    }

    const slotSymbols = ['üçí', 'üçã', 'üçä', 'üçá', 'üçâ', '7Ô∏è‚É£', 'üîî', 'üí∞'];

    function setupSlots() {
        const reels = document.querySelectorAll('.slots-reel');
        reels.forEach(reel => {
            reel.innerHTML = '';
            for (let i = 0; i < 5; i++) {
                const randomSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
                const symbol = document.createElement('div');
                symbol.className = 'slots-symbol';
                symbol.textContent = randomSymbol;
                symbol.style.transform = `translateY(${i * 120}px)`;
                reel.appendChild(symbol);
            }
        });
    }

    async function playSlots() {
        if (!currentUser) return;

        const bet = parseInt(document.getElementById('slots-bet-amount').value);
        const userSnapshot = await get(ref(database, 'users/' + currentUser));
        const user = userSnapshot.val();

        if (isNaN(bet) || bet < 1) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É', true);
            return;
        }
        if (bet > user.balance) {
            showNotification('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', true);
            return;
        }

        const reels = document.querySelectorAll('.slots-reel');
        reels.forEach(reel => reel.classList.add('slots-spinning'));
        const resultEl = document.getElementById('slots-result');
        resultEl.classList.remove('show');

        setTimeout(() => stopSlotReel(reels[0], 0), 1000);
        setTimeout(() => stopSlotReel(reels[1], 1), 1500);
        setTimeout(() => stopSlotReel(reels[2], 2), 2000);
        setTimeout(() => checkSlotsResult(bet), 2500);
    }

    function stopSlotReel(reel, index) {
        reel.classList.remove('slots-spinning');
        const randomSymbol = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        const symbols = reel.querySelectorAll('.slots-symbol');
        symbols.forEach((symbol, i) => {
            if (i === 2) {
                symbol.textContent = randomSymbol;
            } else {
                symbol.textContent = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
            }
            symbol.style.transform = `translateY(${(i - 2) * 120}px)`;
        });
    }

    async function checkSlotsResult(bet) {
        const reels = document.querySelectorAll('.slots-reel');
        const symbols = [];

        reels.forEach(reel => {
            const centerSymbol = reel.querySelectorAll('.slots-symbol')[2];
            symbols.push(centerSymbol.textContent);
        });

        let winAmount = 0;
        let winMessage = '';
        if (symbols[0] === symbols[1] && symbols[1] === symbols[2]) {
            if (symbols[0] === '7Ô∏è‚É£') {
                winAmount = bet * 10;
                winMessage = '–î–ñ–ï–ö–ü–û–¢! –¢—Ä–∏ 7Ô∏è‚É£!';
            } else if (symbols[0] === 'üí∞') {
                winAmount = bet * 5;
                winMessage = '–û—Ç–ª–∏—á–Ω–æ! –¢—Ä–∏ üí∞!';
            } else {
                winAmount = bet * 3;
                winMessage = `–•–æ—Ä–æ—à–æ! –¢—Ä–∏ ${symbols[0]}!`;
            }
        } else if (symbols[0] === symbols[1] || symbols[1] === symbols[2] || symbols[0] === symbols[2]) {
            winAmount = bet;
            winMessage = '–ù–µ –ø–ª–æ—Ö–æ! –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Å–∏–º–≤–æ–ª–∞!';
        }

        const resultEl = document.getElementById('slots-result');
        if (winAmount > 0) {
            await update(ref(database, 'users/' + currentUser), {
                balance: user.balance + winAmount
            });
            resultEl.textContent = `${winMessage} –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ $${winAmount}!`;
            resultEl.classList.add('show', 'result-win');
            addToHistory('slots', {
                symbols: symbols,
                amount: winAmount,
                win: true
            });
        } else {
            await update(ref(database, 'users/' + currentUser), {
                balance: user.balance - bet
            });
            resultEl.textContent = `${symbols.join(' ')}. –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ $${bet}.`;
            resultEl.classList.add('show', 'result-lose');
            addToHistory('slots', {
                symbols: symbols,
                amount: bet,
                win: false
            });
        }

        updateUserInfo();
    }

    function selectCoinSide(side) {
        selectedCoinSide = side;
        showNotification(`–í—ã –≤—ã–±—Ä–∞–ª–∏: ${side === 'heads' ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞'}`);
    }

    async function playCoin() {
        if (!currentUser) return;

        const bet = parseInt(document.getElementById('coin-bet-amount').value);
        const userSnapshot = await get(ref(database, 'users/' + currentUser));
        const user = userSnapshot.val();

        if (isNaN(bet) || bet < 1) {
            showNotification('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—Ç–∞–≤–∫—É', true);
            return;
        }
        if (!selectedCoinSide) {
            showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ—Ä–æ–Ω—É –º–æ–Ω–µ—Ç—ã', true);
            return;
        }

        const result = Math.random() < 0.5 ? 'heads' : 'tails';

        if (result === selectedCoinSide) {
            const winAmount = bet * 2;
            await update(ref(database, 'users/' + currentUser), {
                balance: user.balance + winAmount
            });
            addToHistory('coin', {
                choice: selectedCoinSide,
                result: result,
                amount: winAmount,
                win: true
            });
            showNotification(`–í—ã–ø–∞–ª–æ: ${result === 'heads' ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞'}. –í—ã –≤—ã–∏–≥—Ä–∞–ª–∏ $${winAmount}!`);
        } else {
            await update(ref(database, 'users/' + currentUser), {
                balance: user.balance - bet
            });
            addToHistory('coin', {
                choice: selectedCoinSide,
                result: result,
                amount: bet,
                win: false
            });
            showNotification(`–í—ã–ø–∞–ª–æ: ${result === 'heads' ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞'}. –í—ã –ø—Ä–æ–∏–≥—Ä–∞–ª–∏ $${bet}.`);
        }

        updateUserInfo();
    }

    async function depositBalance() {
        const input = document.getElementById('deposit-amount').value.trim().toLowerCase();
        const userSnapshot = await get(ref(database, 'users/' + currentUser));
        const user = userSnapshot.val();

        if (input === '‚àû' || input === 'inf' || input === 'infinite') {
            showNotification("–£–¥–∞–ª–µ–Ω–æ: –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π –±–∞–ª–∞–Ω—Å –±–æ–ª—å—à–µ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.", true);
            return;
        }

        const amount = parseInt(input);
        if (isNaN(amount) || amount < 1) {
            showNotification("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É", true);
            return;
        }

        const totalDeposited = user.balance + amount;

        if (totalDeposited > 10000) {
            showNotification("–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è (–º–∞–∫—Å–∏–º—É–º 10000)", true);
            return;
        }

        await update(ref(database, 'users/' + currentUser), {
            balance: totalDeposited
        });

        showNotification(`–ë–∞–ª–∞–Ω—Å —É—Å–ø–µ—à–Ω–æ –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ $${amount}`);
        updateUserInfo();
        hideDeposit();
    }

    function logout() {
        currentUser = null;
        document.getElementById('casino').style.display = 'none';
        document.getElementById('auth-forms').style.display = 'block';
        showLogin();
    }

    function switchGame(game) {
        document.querySelectorAll('.game').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.game-tab').forEach(el => el.classList.remove('active'));
        document.getElementById(`${game}-game`).classList.add('active');
        const tabs = document.querySelectorAll('.game-tab');
        for (let tab of tabs) {
            if (tab.textContent.toLowerCase().includes(game)) {
                tab.classList.add('active');
                break;
            }
        }
    }

    function setBetAmount(amount, game) {
        document.getElementById(`${game}-bet-amount`).value = amount;
    }

    function setMaxBet(game) {
        document.getElementById(`${game}-bet-amount`).value = 10000;
    }

    function showDeposit() {
        document.getElementById('deposit-form').style.display = 'block';
        document.querySelector('.game-container').style.display = 'none';
    }

    function hideDeposit() {
        document.getElementById('deposit-form').style.display = 'none';
        document.querySelector('.game-container').style.display = 'block';
    }

    // --- –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ---

    async function loadUserList() {
        const usersRef = ref(database, 'users/');
        const snapshot = await get(usersRef);
        const userList = document.getElementById('userList');
        userList.innerHTML = '';

        snapshot.forEach(childSnapshot => {
            const username = childSnapshot.key;
            const userData = childSnapshot.val();
            const userDiv = document.createElement('div');
            userDiv.className = 'user-item';
            userDiv.innerHTML = `
                <strong>${username}</strong>
                <div class="user-controls">
                    <input type="number" id="balance-${username}" value="${userData.balance}">
                    <button onclick="updateUserBalance('${username}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            `;
            userList.appendChild(userDiv);
        });
    }

    async function updateUserBalance(username) {
        const input = document.getElementById(`balance-${username}`);
        const newBalance = parseInt(input.value);
        if (isNaN(newBalance) || newBalance < 0) {
            showNotification("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞", true);
            return;
        }
        await update(ref(database, 'users/' + username), {
            balance: newBalance
        });
        showNotification(`–ë–∞–ª–∞–Ω—Å ${username} –æ–±–Ω–æ–≤–ª—ë–Ω`);
    }

    async function loadLeaderboard() {
        const usersRef = ref(database, 'users/');
        const snapshot = await get(usersRef);
        const leaderboard = [];

        snapshot.forEach(childSnapshot => {
            const username = childSnapshot.key;
            const userData = childSnapshot.val();
            leaderboard.push({ username, balance: userData.balance });
        });

        leaderboard.sort((a, b) => b.balance - a.balance);

        const leaderboardEl = document.getElementById('leaderboard');
        leaderboardEl.innerHTML = '';

        leaderboard.slice(0, 5).forEach((player, index) => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${index + 1}. ${player.username}</strong>: ${player.balance}`;
            leaderboardEl.appendChild(li);
        });
    }
</script>
